---
name: Generate konflux configurations

on:
  push:
    branches:
      - 'main'
  schedule:
    - cron: "0 6 * * *" # Daily at 06:00.
  workflow_dispatch: # Manual workflow trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'openshift-pipelines' # do not run this elsewhere
    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version: 1.22.x
    - id: set-matrix
      run: |
        echo "projects=$(go run ./cmd/matrix config/konflux/*)" >> $GITHUB_OUTPUT
    outputs:
      projects: ${{ steps.set-matrix.outputs.projects }}
  update-project:
    needs: build-matrix
    if: github.repository_owner == 'openshift-pipelines' # do not run this elsewhere
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJSON(needs.build-matrix.outputs.projects) }}
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4
    - name: Clone ${{matrix.project}}
      uses: actions/checkout@v4
      with:
        repository: openshift-pipelines/${{matrix.project}}
        path: project
    - uses: actions/setup-go@v5
      with:
        go-version: 1.22.x
    - name: Generate configurations
      run: |
        go run ./cmd/konflux/ -target project -config config/konflux/${{matrix.project}}.yaml
        pushd project
        git diff
        popd
