package konflux

import (
	"bytes"
	"embed"
	"log"
	"os"
	"path"
	"path/filepath"
	"regexp"
	"strings"
	"text/template"
)

//go:embed templates/*/*.yaml templates/*/*/*.yaml
var templateFS embed.FS

var nameFieldInvalidCharPattern = regexp.MustCompile("[^a-z0-9]")

func Eval(tmpl string, data interface{}) (string, error) {
	funcMap := template.FuncMap{
		"hyphenize": hyphenize,
		"basename":  basename,
		"indent":    indent,
		"contains":  strings.Contains,
	}
	t, err := template.New("inner").Funcs(funcMap).Parse(tmpl)
	if err != nil {
		return "", err
	}
	var buf bytes.Buffer
	err = t.Execute(&buf, data)
	if err != nil {
		return "", err
	}
	return buf.String(), nil
}
func generateFileFromTemplate(templateFile string, data interface{}, filePath string, application Application) error {
	funcMap := template.FuncMap{
		"hyphenize": hyphenize,
		"basename":  basename,
		"indent":    indent,
		"contains":  strings.Contains,
		"eval":      Eval,
	}
	tmpl, err := template.New(templateFile).Funcs(funcMap).ParseFS(templateFS, "templates/*/*.yaml", "templates/*/*/*.yaml")
	if err != nil {
		return err
	}
	parentDir := filepath.Dir(filePath)
	err = os.MkdirAll(parentDir, os.ModePerm)
	if err != nil {
		log.Fatal("Error creating directory:", parentDir, err)
		return err
	}
	file, err := os.Create(filePath)
	if err != nil {
		return err
	}
	defer file.Close()

	// Add AutoGenerated Header
	header, err := Eval(autoGeneratedHeader, application)
	if err != nil {
		return err
	}
	if _, err := file.WriteString(header + "\n"); err != nil {
		return err
	}

	err = tmpl.Execute(file, data)
	if err != nil {
		return err
	}
	return nil
}
func hyphenize(str string) string {
	return nameFieldInvalidCharPattern.ReplaceAllString(str, "-")
}

func basename(str string) string {
	return path.Base(str)
}

func indent(spaces int, v string) string {
	pad := strings.Repeat(" ", spaces)
	return pad + strings.Replace(v, "\n", "\n"+pad, -1)
}
